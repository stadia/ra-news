# Service Object Extraction Plan - Ruby News

**Generated by Service Objects Specialist Agent - 2025-08-25**

## Executive Summary

This plan outlines the extraction of complex business logic into focused service objects to improve code maintainability, testability, and adherence to single responsibility principles. The plan prioritizes high-impact extractions that will significantly reduce complexity in fat models and jobs.

## Key Issues Identified

### 1. Fat Article Model (285+ lines)
**Location:** `app/models/article.rb`
- Complex URL processing and validation logic
- Metadata extraction and content parsing
- YouTube video handling and thumbnail generation
- Mixed responsibilities violating SRP

### 2. Complex ArticleJob (126+ lines) 
**Location:** `app/jobs/article_job.rb`
- AI processing with RubyLLM integration
- Embedding generation and vector operations
- Content analysis and summarization
- Twitter integration and posting logic

### 3. Scattered Content Processing
- Multiple jobs (RSS, Gmail, YouTube, HackerNews) with similar article creation patterns
- Duplicated error handling and content validation logic
- Inconsistent external API integration patterns

### 4. Controller Business Logic
- Search controllers handling complex similarity calculations
- Content processing mixed with HTTP concerns

## Implementation Plan

### Priority 1: Core Content Processing (Weeks 1-2)

#### 1.1 ArticleContentProcessingService
**Extracts from:** `app/models/article.rb` (lines 45-120)
**Purpose:** Handle URL processing, metadata extraction, and content validation

```ruby
# app/services/article_content_processing_service.rb
class ArticleContentProcessingService
  def initialize(url, title = nil, body = nil)
    @url = url
    @title = title
    @body = body
  end

  def call
    # Extract URL processing logic
    # Handle metadata extraction
    # Validate content format
  end
end
```

**Files to modify:**
- `app/models/article.rb` - Remove URL processing methods
- Create `app/services/article_content_processing_service.rb`
- Update tests in `test/models/article_test.rb`

#### 1.2 AiContentAnalysisService
**Extracts from:** `app/jobs/article_job.rb` (lines 15-80)
**Purpose:** Handle AI processing, summarization, and embedding generation

```ruby
# app/services/ai_content_analysis_service.rb
class AiContentAnalysisService
  def initialize(article)
    @article = article
  end

  def call
    # Process with RubyLLM
    # Generate embeddings
    # Create summary in Korean
    # Handle AI service errors
  end
end
```

**Files to modify:**
- `app/jobs/article_job.rb` - Delegate to service
- Create `app/services/ai_content_analysis_service.rb`
- Update tests in `test/jobs/article_job_test.rb`

#### 1.3 ArticleCreationService
**Extracts from:** Multiple job classes
**Purpose:** Centralize article creation logic with consistent error handling

```ruby
# app/services/article_creation_service.rb
class ArticleCreationService
  def self.create_from_rss(feed_data)
    # Standardized RSS article creation
  end

  def self.create_from_youtube(video_data)
    # Standardized YouTube article creation
  end

  def self.create_from_email(email_data)
    # Standardized Gmail article creation
  end
end
```

**Files to modify:**
- `app/jobs/rss_site_job.rb` - Use centralized service
- `app/jobs/youtube_site_job.rb` - Use centralized service  
- `app/jobs/gmail_article_job.rb` - Use centralized service
- Create `app/services/article_creation_service.rb`

### Priority 2: Content Source Integration (Weeks 3-4)

#### 2.1 FeedProcessingService
**Extracts from:** `app/jobs/rss_site_job.rb`
**Purpose:** Handle RSS feed parsing and article extraction

#### 2.2 EmailContentExtractionService  
**Extracts from:** `app/jobs/gmail_article_job.rb`
**Purpose:** Extract content from Gmail newsletters and emails

#### 2.3 TwitterPostFormattingService
**Extracts from:** `app/jobs/article_job.rb` (lines 85-110)
**Purpose:** Handle social media posting and formatting

### Priority 3: Search and Similarity (Weeks 5-6)

#### 3.1 ArticleSimilarityService
**Extracts from:** Controllers and models
**Purpose:** Handle vector similarity calculations and recommendations

#### 3.2 SearchResultsService
**Extracts from:** Search controllers
**Purpose:** Aggregate and format search results from multiple sources

### Priority 4: External API Integration (Weeks 7-8)

#### 4.1 YoutubeApiService
**Purpose:** Centralize YouTube API interactions

#### 4.2 HackerNewsApiService  
**Purpose:** Centralize HackerNews API interactions

## Implementation Guidelines

### Service Object Conventions
```ruby
# Standard service object pattern
class ServiceName
  def initialize(required_params)
    @param = required_params
  end

  def call
    # Main business logic
    # Return Result object or data
  end

  private

  def helper_methods
    # Internal implementation
  end
end

# Usage pattern
result = ServiceName.new(params).call
```

### Error Handling Pattern
```ruby
class ServiceResult
  attr_reader :success, :data, :errors

  def initialize(success:, data: nil, errors: [])
    @success = success
    @data = data
    @errors = errors
  end

  def success?
    @success
  end

  def failure?
    !@success
  end
end
```

### Testing Strategy
- Unit tests for each service object
- Integration tests to ensure proper delegation
- Korean content-specific test cases
- AI processing mock strategies
- Performance benchmarks for critical paths

## Dependencies and Sequencing

1. **ArticleContentProcessingService** → Must be completed before other article services
2. **AiContentAnalysisService** → Can be developed in parallel with content processing
3. **ArticleCreationService** → Depends on content processing service
4. **Feed/Email/Twitter services** → Depend on article creation service
5. **Search services** → Can be developed independently
6. **API services** → Can be developed independently

## Success Metrics

### Code Quality Improvements
- Article model: 285 lines → ~150 lines (47% reduction)
- ArticleJob: 126 lines → ~50 lines (60% reduction)
- Cyclomatic complexity reduction by 40%
- Test coverage increase to 95%+

### Performance Targets
- Article processing time: maintain < 2 seconds
- AI analysis: maintain current Korean processing accuracy
- Vector similarity calculations: < 100ms per query
- Background job failure rate: < 1%

### Maintainability Gains
- Single responsibility per service
- Clear interface contracts
- Improved error handling
- Better separation of concerns
- Enhanced testability for Korean content

## Korean Localization Considerations

- Maintain Korean text processing accuracy
- Preserve Asia/Seoul timezone handling
- Keep Korean error messages in user-facing code
- Ensure AI summaries remain in Korean
- Test Korean character encoding throughout services

## Migration Strategy

1. **No Breaking Changes:** Existing interfaces maintained during transition
2. **Gradual Extraction:** One service at a time with comprehensive testing
3. **Feature Flags:** Use feature toggles for new service implementations
4. **Performance Monitoring:** Track metrics before and after each extraction
5. **Rollback Plan:** Maintain ability to revert any service extraction

## Next Steps

1. **Week 1:** Begin with ArticleContentProcessingService extraction
2. **Create test suite** for service object patterns
3. **Set up monitoring** for performance impact
4. **Review with team** before proceeding to Priority 2 items

---

This plan will significantly improve the codebase architecture while maintaining the platform's core functionality for Korean Ruby community news aggregation and AI-powered content processing.